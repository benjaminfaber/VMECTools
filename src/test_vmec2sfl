program test_vmec2sfl

  use vmec2sfl_vars_mod
  use vmec2sfl_io_mod
  use vmec2sfl_mod

  implicit none

  !*********************************************************************
  ! Variables used internally by this program
  !*********************************************************************
  integer :: j, k, iunit
  real :: iota, nfp
  character(len=256) :: filename

  !*********************************************************************
  ! Input parameters
  !*********************************************************************

  !character(len=2000) :: vmec_filename = 'equilibria/wout_w7x_standardConfig.nc'
  !vmec_filename = 'equilibria/wout_QHS_good.00000.nc'
  !vmec_filename = 'wout_QHS_good.00000.nc'
!  character(len=2000) :: vmec_filename = 'equilibria/wout_161s1.nc'
  !nalpha = 1
  !nzgrid = 512 
  !zeta_center = 0.0
  !number_of_field_periods_to_include = 4
  !desired_normalized_toroidal_flux = 0.5d+0
  !vmec_surface_option = 1
  !verbose = .false.

  !*********************************************************************
  ! Output arrays
  !*********************************************************************
  
  allocate(alpha(nalpha))
  allocate(zeta(-nzgrid:nzgrid))
  allocate(bmag(nalpha,-nzgrid:nzgrid))
  allocate(gradpar(nalpha,-nzgrid:nzgrid))
  allocate(gds2(nalpha,-nzgrid:nzgrid))
  allocate(gds21(nalpha,-nzgrid:nzgrid))
  allocate(gds22(nalpha,-nzgrid:nzgrid))
  allocate(gbdrift(nalpha,-nzgrid:nzgrid))
  allocate(gbdrift0(nalpha,-nzgrid:nzgrid))
  allocate(cvdrift(nalpha,-nzgrid:nzgrid))
  allocate(cvdrift0(nalpha,-nzgrid:nzgrid))
  allocate(jac_gist_inv(nalpha,-nzgrid:nzgrid))
  allocate(d_B_d_par(nalpha,-nzgrid:nzgrid))
  !*********************************************************************
  ! Beginning of executable statements
  !*********************************************************************
  filename = 'input_file'
  call read_input(filename)

  vmec_filename = geom_file
  nzgrid = points_per_turn/2
  zeta_center = z_center
  desired_normalized_toroidal_flux = s0
  vmec_surface_option = surf_opt

  call read_vmec(nfp)
print *, nfp
  number_of_field_periods_to_include = real(n_turns) * nfp
  call vmec2sfl

  print *,"-------------- Input parameters ------------------"
  print *,"vmec_filename: ",trim(vmec_filename)
  print *,"nalpha:",nalpha
  print *,"nzgrid:",nzgrid
  print *,"zeta_center:",zeta_center
  print *,"number_of_field_periods_to_include:",number_of_field_periods_to_include
  print *,"desired_normalized_toroidal_flux:",desired_normalized_toroidal_flux
  print *,"vmec_surface_option:",vmec_surface_option

  print *,"-------------- Output parameters -----------------"
  print *,"normalized_toroidal_flux_used:",normalized_toroidal_flux_used
  print *,"safety_factor_q:",safety_factor_q
  print *,"shat:",shat
  print *,"L_reference:",L_reference
  print *,"B_reference:",B_reference
!  print *,"alpha:"
!  print *,alpha
!  print *,"zeta:"
!  print *,zeta

  iota = 1.0/safety_factor_q
!  print *,"bmag:"
!  do j=1,nalpha
!     print *,bmag(j,:)
!  end do
!
!  print *,"gradpar:"
!  do j=1,nalpha
!     print *,gradpar(j,:)
!  end do
!
!  print *,"gds2:"
!  do j=1,nalpha
!     print *,gds2(j,:)
!  end do
!
!  print *,"gds21:"
!  do j=1,nalpha
!     print *,gds21(j,:)
!  end do
!
!  print *,"gds22:"
!  do j=1,nalpha
!     print *,gds22(j,:)
!  end do
!
!  print *,"gbdrift:"
!  do j=1,nalpha
!     print *,gbdrift(j,:)
!  end do
!
!  print *,"gbdrift0:"
!  do j=1,nalpha
!     print *,gbdrift0(j,:)
!  end do
!
!  print *,"cvdrfit:"
!  do j=1,nalpha
!     print *,cvdrift(j,:)
!  end do
!
!  print *,"cvdrift0:"
!  do j=1,nalpha
!     print *,cvdrift0(j,:)
!  end do

  iunit = 500
  open(file='gist.dat',unit=iunit)
  write (iunit,*) '&parameters'
  write (iunit,*) 's0 = ', desired_normalized_toroidal_flux 
  write (iunit,*) 'minor_a = ', L_reference
  write (iunit,*) 'Bref = ', B_reference
  write (iunit,*) 'q0 = ', safety_factor_q
  write (iunit,*) 'shat = ', shat
  write (iunit,*) 'gridpoints = ', nzgrid
  write (iunit,*) 'npol = ', number_of_field_periods_to_include
  write (iunit,*) '/'
  do j=1,nalpha
    do k=-nzgrid, nzgrid
      write(iunit,'(9(E22.12,2x))')  gds22(j,k), gds21(j,k), gds2(j,k) ,bmag(j,k), &
      & abs(1/jac_gist_inv(j,k)), cvdrift(j,k), cvdrift0(j,k), d_B_d_par(j,k), iota*zeta(k)
    end do
  end do

  iunit = 6
  open(file='geometry.dat',unit=iunit)
  !write (iunit,*) 'nalpha nzgrid'
  write (iunit,*) '#nalpha nzgrid'
  write (iunit,*) nalpha, nzgrid
  write (iunit,*) ' '
  !write (iunit,*) 'alpha'
  !write (iunit,*) alpha
  !write (iunit,*) 'zeta'
  !write (iunit,*) zeta

  !write (iunit,*) 'bmag'
  write (iunit,*) '#bmag'
  do j=1,nalpha
   do k = -nzgrid, nzgrid
     !write (iunit,*) bmag(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), bmag(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'gradpar'
  write (iunit,*) '#gradpar'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) gradpar(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), gradpar(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'gds2'
  write (iunit,*) '#gds2'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) gds2(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), gds2(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'gds21'
  write (iunit,*) '#gds21'
  do j=1,nalpha
    do k=-nzgrid, nzgrid
     !write (iunit,*) gds21(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), gds21(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'gds22'
  write (iunit,*) '#gds22'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) gds22(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), gds22(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'gbdrift'
  write (iunit,*) '#gbdrift'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) gbdrift(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), gbdrift(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'gbdrift0'
  write (iunit,*) '#gbdrift0'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) gbdrift0(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), gbdrift0(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'cvdrift'
  write (iunit,*) '#cvdrift'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) cvdrift(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), 0.5*bmag(j,k)*cvdrift(j,k)
    end do
  end do
  write (iunit,*) ' '

  !write (iunit,*) 'cvdrift0'
  write (iunit,*) '#cvdrift0'
  do j=1,nalpha
    do k = -nzgrid, nzgrid
     !write (iunit,*) cvdrift0(j,:)
     write (iunit,*) zeta(k), iota*zeta(k), cvdrift0(j,k)
    end do
  end do

  close(iunit)

  deallocate(alpha,zeta,bmag,gradpar,gds2,gds21,gds22,gbdrift,gbdrift0,&
    & cvdrift,cvdrift0,jac_gist_inv,d_B_d_par)

end program test_vmec2sfl
